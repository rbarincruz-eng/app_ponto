<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ponto Pro - Cliente API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>.hidden { display: none; } .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; }</style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">

    <script>
        // ==========================================
        // CONFIGURAÇÃO DA PONTE (API)
        // ==========================================
        const API_BASE_URL = "https://app-ponto-v1.onrender.com/api"; // URL do seu Back-end real
        let USUARIO_LOGADO = { id: 1, nome: "Ricardo Silva" }; // Simulação de usuário vindo do login
        let locaisAutorizados = []; // Será preenchido pela API

        // ==========================================
        // 1. CARREGAR DADOS DO SERVIDOR (GET)
        // ==========================================
        async function carregarDadosIniciais() {
            try {
                // Busca os locais que este usuário pode trabalhar
                const response = await fetch(`${API_BASE_URL}/locais?usuario_id=${USUARIO_LOGADO.id}`);
                locaisAutorizados = await response.json();
                atualizarListaLocaisAdmin(); // Atualiza a UI
                console.log("Locais sincronizados com o banco de dados");
            } catch (error) {
                console.error("Erro ao conectar com a API:", error);
            }
        }

        // ==========================================
        // 2. REGISTRAR PONTO (POST)
        // ==========================================
        async function handlePonto(tipo) {
            const btn = event.currentTarget;
            const originalHTML = btn.innerHTML;
            
            // UI Feedback
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin text-3xl"></i>`;

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude, longitude } = pos.coords;
                
                // Envia para o Back-end validar a distância e salvar no Banco
                try {
                    const response = await fetch(`${API_BASE_URL}/ponto/registrar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            usuario_id: USUARIO_LOGADO.id,
                            lat_atual: latitude,
                            lon_atual: longitude,
                            tipo: tipo // 'ENTRADA' ou 'SAÍDA'
                        })
                    });

                    const resultado = await response.json();

                    if (response.ok) {
                        alert(`✅ Sucesso: ${resultado.mensagem}`);
                        document.getElementById('prestador-log').innerHTML = `Último registro: ${tipo} às ${new Date().toLocaleTimeString()}`;
                    } else {
                        alert(`❌ Erro: ${resultado.erro}`);
                    }
                } catch (error) {
                    alert("Erro de conexão com o servidor.");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }
            }, (err) => {
                alert("Ative o GPS para bater o ponto.");
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }, { enableHighAccuracy: true });
        }

        // ==========================================
        // 3. CADASTRAR NOVO LOCAL (POST)
        // ==========================================
        async function salvarLocalNaLista() {
            const nome = document.getElementById('admin-nome-local').value;
            const coords = document.getElementById('admin-coords').value;
            
            if (!nome || !coords) return alert("Preencha os dados.");
            const [lat, lon] = coords.split(',').map(Number);

            try {
                const response = await fetch(`${API_BASE_URL}/locais`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome_local: nome, latitude: lat, longitude: lon })
                });

                if (response.ok) {
                    alert("Local salvo no Banco de Dados!");
                    carregarDadosIniciais(); // Recarrega a lista
                }
            } catch (error) {
                alert("Erro ao salvar local.");
            }
        }

        // ==========================================
        // 4. RECUPERAR SENHA (POST)
        // ==========================================
        async function simularEnvioEmail() {
            const email = document.getElementById('forgot-email').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/esqueci-senha`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });
                
                const res = await response.json();
                alert(res.mensagem);
                navigateTo('screen-login');
            } catch (error) {
                alert("Erro ao processar solicitação.");
            }
        }

        // Inicialização automática ao carregar a página
        document.addEventListener('DOMContentLoaded', carregarDadosIniciais);

        // [MANTEMOS AS FUNÇÕES DE NAVEGAÇÃO E UI AUXILIARES...]
        function navigateTo(id) { /* ... */ }
        function switchTab(id) { /* ... */ }
    </script>
</body>
</html>
