<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ponto Pro - Sistema Georreferenciado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .hidden { display: none !important; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; }
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">

    <div id="screen-login" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm border border-gray-100">
            <div class="text-center mb-8">
                <div class="inline-block p-4 bg-blue-100 rounded-2xl text-blue-600 mb-4">
                    <i class="fas fa-user-check text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold">Bem-vindo</h1>
                <p class="text-gray-500 text-sm">Controle do Ponto</p>
            </div>
            <div class="space-y-4">
                <input type="email" id="login-email" placeholder="E-mail" class="w-full px-4 py-3 rounded-xl bg-gray-50 border outline-none focus:ring-2 focus:ring-blue-200 transition">
                <input type="password" id="login-pass" placeholder="Senha" class="w-full px-4 py-3 rounded-xl bg-gray-50 border outline-none focus:ring-2 focus:ring-blue-200 transition">
                <button onclick="fazerLogin()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 active:scale-95 transition shadow-lg">ENTRAR</button>
                <p onclick="navigateTo('screen-forgot')" class="text-center text-sm text-blue-600 font-medium cursor-pointer hover:underline">Esqueci minha senha</p>
            </div>
        </div>
    </div>

    <div id="screen-forgot" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm border border-gray-100">
            <button onclick="navigateTo('screen-login')" class="mb-4 text-gray-400 hover:text-blue-600 transition text-sm">
                <i class="fas fa-arrow-left mr-1"></i> Voltar ao login
            </button>
            <div class="text-center mb-8">
                <div class="inline-block p-4 bg-orange-100 rounded-2xl text-orange-600 mb-4">
                    <i class="fas fa-key text-2xl"></i>
                </div>
                <h1 class="text-xl font-bold">Recuperar Senha</h1>
                <p class="text-gray-500 text-xs mt-2">Enviaremos um link de recuperação para o seu e-mail.</p>
            </div>
            <input type="email" id="forgot-email" placeholder="Seu e-mail cadastrado" class="w-full px-4 py-3 rounded-xl bg-gray-50 border mb-4 outline-none focus:ring-2 focus:ring-orange-200 transition">
            <button onclick="recuperarSenhaAPI()" class="w-full bg-orange-500 text-white py-4 rounded-xl font-bold hover:bg-orange-600 transition shadow-lg">ENVIAR LINK</button>
        </div>
    </div>

    <div id="screen-prestador" class="hidden max-w-md mx-auto min-h-screen bg-white shadow-xl flex flex-col">
        <header class="p-6 bg-blue-600 text-white rounded-b-[2rem] shadow-lg">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-blue-100 text-xs italic">Bem-vindo,</p>
                    <h2 class="text-xl font-bold" id="user-display-name">Carregando...</h2>
                </div>
                <button onclick="navigateTo('screen-login')" class="bg-blue-500 p-2 rounded-lg"><i class="fas fa-sign-out-alt"></i></button>
            </div>
            <div class="mt-4 flex items-center gap-2 text-sm bg-blue-700/50 w-fit px-3 py-1 rounded-full">
                <i class="fas fa-map-marker-alt"></i> <span id="current-location-status">Validando GPS...</span>
            </div>
        </header>

        <main class="flex-1 p-6 space-y-6">
            <div class="grid gap-4">
                <button onclick="handlePonto('ENTRADA')" class="flex items-center justify-between p-6 bg-emerald-500 text-white rounded-2xl shadow-lg active:scale-95 transition">
                    <div class="text-left"><span class="block text-xs opacity-80 font-bold uppercase">Check-in</span><span class="text-xl font-black italic">ENTRADA</span></div>
                    <i class="fas fa-play-circle text-3xl"></i>
                </button>
                <button onclick="handlePonto('SAÍDA')" class="flex items-center justify-between p-6 bg-rose-500 text-white rounded-2xl shadow-lg active:scale-95 transition">
                    <div class="text-left"><span class="block text-xs opacity-80 font-bold uppercase">Check-out</span><span class="text-xl font-black italic">SAÍDA</span></div>
                    <i class="fas fa-stop-circle text-3xl"></i>
                </button>
            </div>
            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                <h3 class="text-blue-700 font-bold text-xs mb-2 uppercase tracking-widest">Atividade Recente</h3>
                <div id="prestador-log" class="text-sm text-blue-600 italic">Nenhum registro hoje.</div>
            </div>
        </main>
        
        <footer class="p-4 text-center border-t">
            <button onclick="navigateTo('screen-admin')" class="text-gray-400 text-[10px] font-bold uppercase tracking-widest hover:text-blue-600">Painel Administrativo</button>
        </footer>
    </div>

    <div id="screen-admin" class="hidden min-h-screen p-4 md:p-8 bg-gray-50">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-2xl font-black text-gray-900 italic tracking-tighter">GESTOR PRO</h1>
                <button onclick="navigateTo('screen-prestador')" class="text-blue-600 font-bold text-sm"><i class="fas fa-arrow-left mr-2"></i>Voltar</button>
            </div>

            <div class="flex gap-6 mb-6 border-b text-sm font-bold uppercase tracking-tighter">
                <button onclick="switchTab('tab-relatorios')" id="btn-tab-relatorios" class="tab-active pb-2">Relatórios</button>
                <button onclick="switchTab('tab-locais')" id="btn-tab-locais" class="pb-2 text-gray-400">Locais</button>
            </div>

            <div id="tab-relatorios">
                <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center bg-gray-50/50">
                        <span class="text-xs font-bold text-gray-400 uppercase">Registros Gerais</span>
                        <button onclick="exportarCSV()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-md">CSV</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-gray-400 uppercase text-[10px]">
                                <tr><th class="p-4">Prestador</th><th class="p-4">Local</th><th class="p-4">Data</th><th class="p-4">Entrada</th><th class="p-4">Saída</th></tr>
                            </thead>
                            <tbody id="table-body-relatorio" class="divide-y text-gray-600">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-locais" class="hidden space-y-4">
                <div class="bg-white p-6 rounded-3xl border shadow-sm">
                    <h3 class="font-bold mb-4">Novo Local de Serviço</h3>
                    <div class="space-y-3">
                        <input type="text" id="admin-nome-local" placeholder="Nome do Local" class="w-full p-3 bg-gray-50 border rounded-xl outline-none">
                        <div class="flex gap-2">
                            <input type="text" id="admin-coords" placeholder="Lat, Lon" class="flex-1 p-3 bg-gray-200 border rounded-xl font-mono text-xs" readonly>
                            <button onclick="capturarLocalizacaoAdmin()" class="bg-blue-600 text-white px-4 rounded-xl"><i class="fas fa-crosshairs"></i></button>
                        </div>
                        <button onclick="salvarLocalAPI()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold uppercase text-xs">Salvar Local no Banco</button>
                    </div>
                </div>
                <div id="lista-locais-admin" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURAÇÕES DA API (Atualize aqui com o link do seu Render)
        const API_BASE_URL = "https://app-ponto-v1.onrender.com/api"; 
        let user_id = 1; // ID padrão para teste enquanto o login real não é feito

        // NAVEGAÇÃO BÁSICA (Sempre funciona, independente da API)
        function navigateTo(screenId) {
            document.querySelectorAll('[id^="screen-"]').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function switchTab(tabId) {
            document.getElementById('tab-relatorios').classList.add('hidden');
            document.getElementById('tab-locais').classList.add('hidden');
            document.getElementById('btn-tab-relatorios').classList.remove('tab-active', 'text-blue-600');
            document.getElementById('btn-tab-locais').classList.remove('tab-active', 'text-blue-600');
            
            document.getElementById(tabId).classList.remove('hidden');
            document.getElementById('btn-' + tabId).classList.add('tab-active', 'text-blue-600');
        }

        // FUNÇÕES DE COMUNICAÇÃO COM O SERVIDOR
        async function fazerLogin() {
            // No futuro, aqui você chamará a API de login real
            document.getElementById('user-display-name').innerText = "Ricardo Silva";
            navigateTo('screen-prestador');
        }

        async function handlePonto(tipo) {
            const btn = event.currentTarget;
            const original = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin text-2xl"></i>`;

            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const res = await fetch(`${API_BASE_URL}/ponto/registrar`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            usuario_id: user_id,
                            lat_atual: pos.coords.latitude,
                            lon_atual: pos.coords.longitude,
                            tipo: tipo
                        })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        alert("✅ " + data.mensagem);
                        document.getElementById('prestador-log').innerText = `${tipo} registrado em ${new Date().toLocaleTimeString()}`;
                    } else {
                        alert("❌ " + data.erro);
                    }
                } catch (e) {
                    alert("Erro ao conectar com o servidor.");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = original;
                }
            }, () => {
                alert("GPS desativado.");
                btn.disabled = false;
                btn.innerHTML = original;
            }, { enableHighAccuracy: true });
        }

        async function salvarLocalAPI() {
            const nome = document.getElementById('admin-nome-local').value;
            const coords = document.getElementById('admin-coords').value;
            if(!nome || !coords) return alert("Preencha os campos.");
            
            const [lat, lon] = coords.split(',').map(Number);
            try {
                const res = await fetch(`${API_BASE_URL}/locais`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ nome_local: nome, latitude: lat, longitude: lon })
                });
                if(res.ok) {
                    alert("Local salvo!");
                    document.getElementById('admin-nome-local').value = "";
                }
            } catch (e) { alert("Erro de rede."); }
        }

        function capturarLocalizacaoAdmin() {
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('admin-coords').value = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
            });
        }

        function recuperarSenhaAPI() {
            const email = document.getElementById('forgot-email').value;
            if(!email) return alert("Digite o e-mail.");
            alert("Solicitação enviada para o servidor! Verifique seu e-mail em instantes.");
            navigateTo('screen-login');
        }

        function exportarCSV() {
            let csv = "\uFEFFPrestador;Local;Data;Entrada;Saída\nRicardo Silva;Sede;27/12/2025;08:00;--:--";
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "relatorio.csv";
            a.click();
        }
    </script>
</body>
</html>
